<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.6">
<title>services.customer_service API documentation</title>
<meta name="description" content="">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source > summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible;min-width:max-content}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin:1em 0}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
/* Collapse source docstrings */
setTimeout(() => {
[...document.querySelectorAll('.hljs.language-python > .hljs-string')]
.filter(el => el.innerHTML.length > 200 && ['"""', "'''"].includes(el.innerHTML.substring(0, 3)))
.forEach(el => {
let d = document.createElement('details');
d.classList.add('hljs-string');
d.innerHTML = '<summary>"""</summary>' + el.innerHTML.substring(3);
el.replaceWith(d);
});
}, 100);
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>services.customer_service</code></h1>
</header>
<section id="section-intro">
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="services.customer_service.CustomerService"><code class="flex name class">
<span>class <span class="ident">CustomerService</span></span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class CustomerService:
    &#34;&#34;&#34;Customer service layer for accounts, payment methods, carts, showings, products, and deliveries.

    This module centralizes customer-facing business logic on top of SQLAlchemy models,
    and coordinates with user, staff, and driver services.
    &#34;&#34;&#34;

    def __init__(self):
        &#34;&#34;&#34;Initialize dependent services used by customer operations.&#34;&#34;&#34;
        self.user_service = UserService()
        self.staff_service = StaffService(0)
        self.driver_service = DriverService()

    def validate_customer(self, user_id):
        &#34;&#34;&#34;Ensure the given user_id belongs to a customer.

        Args:
            user_id: The user id to validate.

        Returns:
            Customers: The customer record associated with user_id.

        Raises:
            ValueError: If no customer exists for the given user_id.
        &#34;&#34;&#34;
        customer = Customers.query.filter_by(user_id=user_id).first()
        if not customer:
            raise ValueError(f&#34;Customer {user_id} not found&#34;)
        return customer

    def get_customer(self, user_id):
        &#34;&#34;&#34;Fetch the customer record for a given user id.

        Args:
            user_id: The user id to look up.

        Returns:
            Customers: The customer record.
        &#34;&#34;&#34;
        customer = self.validate_customer(user_id=user_id)
        return customer

    def create_customer(self, name, email, phone, birthday, password, role, default_theatre_id):
        &#34;&#34;&#34;Create a user with the customer role and a matching customer profile.

        Args:
            name: Customer full name.
            email: Unique email address.
            phone: Unique phone number.
            birthday: Date of birth (YYYY-MM-DD or date).
            password: Plaintext password to hash and store.
            role: Must be &#39;customer&#39;.
            default_theatre_id: Theatre id to set as the customer&#39;s default.

        Returns:
            Customers: The newly created customer profile.

        Raises:
            ValueError: If role is not &#39;customer&#39; or the theatre id is invalid.
        &#34;&#34;&#34;
        if role != &#39;customer&#39;:
            raise ValueError(&#34;User role is not &#39;customer&#39;&#34;)

        user = self.user_service.create_user(
            name=name,
            email=email,
            phone=phone,
            birthday=birthday,
            password=password,
            role=role
        )

        theatre = Theatres.query.filter_by(id=default_theatre_id).first()
        if not theatre:
            raise ValueError(f&#34;Theatre {default_theatre_id} not found&#34;)

        customer = Customers(user_id=user.id, default_theatre_id=default_theatre_id)
        db.session.add(customer)
        db.session.commit()
        return customer

    def delete_customer(self, user_id):
        &#34;&#34;&#34;Delete a customer by removing the underlying user.

        Args:
            user_id: Customer&#39;s user id.

        Returns:
            None

        Raises:
            ValueError: If the customer does not exist.
        &#34;&#34;&#34;
        customer = self.get_customer(user_id=user_id)
        self.user_service.delete_user(user_id=customer.user_id)

    def update_default_theatre(self, user_id, new_theatre_id):
        &#34;&#34;&#34;Set a customer&#39;s default theatre.

        Args:
            user_id: Customer&#39;s user id.
            new_theatre_id: Theatre id to set as default.

        Returns:
            Customers: The updated customer record.

        Raises:
            ValueError: If customer or theatre is not found.
        &#34;&#34;&#34;
        customer = self.get_customer(user_id=user_id)
        theatre = Theatres.query.filter_by(id=new_theatre_id).first()
        if not theatre:
            raise ValueError(f&#34;Theatre {new_theatre_id} not found&#34;)

        customer.default_theatre_id = theatre.id
        db.session.commit()
        return customer

    def add_payment_method(self, user_id, card_number, expiration_month, expiration_year, billing_address, balance, is_default):
        &#34;&#34;&#34;Add a new payment method for a customer.

        Args:
            user_id: Customer&#39;s user id.
            card_number: 16-character card number string.
            expiration_month: Integer month 1–12.
            expiration_year: Four-digit expiration year.
            billing_address: Billing address string.
            balance: Initial stored balance for testing/demo.
            is_default: Whether this card is the default.

        Returns:
            PaymentMethods: The created payment method.

        Raises:
            ValueError: If a duplicate payment method exists for the same card and expiry.
        &#34;&#34;&#34;
        customer = self.get_customer(user_id=user_id)
        existing_payment_method = PaymentMethods.query.filter_by(
            customer_id=customer.user_id,
            card_number=card_number,
            expiration_month=expiration_month,
            expiration_year=expiration_year
        ).first()
        if existing_payment_method:
            raise ValueError(&#34;Payment method already exists for this user&#34;)

        payment_method = PaymentMethods(
            customer_id=customer.user_id,
            card_number=card_number,
            expiration_month=expiration_month,
            expiration_year=expiration_year,
            billing_address=billing_address,
            balance=balance,
            is_default=is_default
        )
        db.session.add(payment_method)
        db.session.commit()
        return payment_method

    def delete_payment_method(self, payment_method_id):
        &#34;&#34;&#34;Remove a payment method by id.

        Args:
            payment_method_id: Payment method primary key.

        Returns:
            bool: True if deleted.

        Raises:
            ValueError: If the payment method does not exist.
        &#34;&#34;&#34;
        payment_method = PaymentMethods.query.filter_by(id=payment_method_id).first()
        if not payment_method:
            raise ValueError(&#34;Payment method not found&#34;)

        db.session.delete(payment_method)
        db.session.commit()
        return True

    def add_funds_to_payment_method(self, payment_method_id, amount):
        &#34;&#34;&#34;Increase a payment method&#39;s balance.

        Args:
            payment_method_id: Payment method id.
            amount: Positive decimal amount to add.

        Returns:
            PaymentMethods: The updated payment method.

        Raises:
            ValueError: If amount is not greater than zero or method not found.
        &#34;&#34;&#34;
        if amount &lt;= 0.00:
            raise ValueError(&#34;Amount to add must be greater than zero&#34;)

        payment_method = PaymentMethods.query.filter_by(id=payment_method_id).first()
        if not payment_method:
            raise ValueError(&#34;Payment method not found&#34;)

        payment_method.balance += decimal.Decimal(amount)
        db.session.commit()
        return payment_method

    def get_customer_payment_methods(self, customer_id):
        &#34;&#34;&#34;List all payment methods for a customer.

        Args:
            customer_id: Customer&#39;s user id.

        Returns:
            list[PaymentMethods]: All payment methods for the customer (possibly empty).
        &#34;&#34;&#34;
        payment_methods = PaymentMethods.query.filter(PaymentMethods.customer_id == customer_id).all()
        return payment_methods

    def create_customer_showing(self, user_id, movie_showing_id, seat_id):
        &#34;&#34;&#34;Book a seat for a specific movie showing for a customer.

        Args:
            user_id: Customer&#39;s user id.
            movie_showing_id: Target MovieShowings id.
            seat_id: Target seat id in the showing&#39;s auditorium.

        Returns:
            CustomerShowings: The created booking record.

        Raises:
            ValueError: If customer, showing, seat is missing, or a duplicate booking exists.
        &#34;&#34;&#34;
        customer = self.get_customer(user_id=user_id)
        movie_showing = MovieShowings.query.filter_by(id=movie_showing_id).first()
        if not movie_showing:
            raise ValueError(f&#34;Movie Showing {movie_showing_id} not found&#34;)

        seat = Seats.query.filter_by(id=seat_id).first()
        if not seat:
            raise ValueError(f&#34;Seat {seat_id} not found&#34;)

        existing_showing = CustomerShowings.query.filter_by(
            customer_id=customer.user_id,
            movie_showing_id=movie_showing.id,
            seat_id=seat.id
        ).first()
        if existing_showing:
            raise ValueError(f&#34;Identical customer showing found&#34;)

        customer_showing = CustomerShowings(
            customer_id=customer.user_id,
            movie_showing_id=movie_showing.id,
            seat_id=seat.id
        )
        db.session.add(customer_showing)
        db.session.commit()
        return customer_showing

    def create_cart_item(self, customer_id, product_id, quantity):
        &#34;&#34;&#34;Add a product to the cart or increment quantity if it already exists.

        Args:
            customer_id: Customer&#39;s user id.
            product_id: Product id to add.
            quantity: Positive integer quantity to add.

        Returns:
            CartItems: The created or updated cart item.

        Raises:
            ValueError: If quantity is invalid, product is not found, or insufficient inventory.
        &#34;&#34;&#34;
        if quantity &lt;= 0:
            raise ValueError(&#34;Quantity to add must be greater than zero&#34;)

        customer = self.get_customer(user_id=customer_id)
        product = Products.query.filter_by(id=product_id).first()
        if not product:
            raise ValueError(f&#34;Product {product_id} not found&#34;)

        if product.inventory_quantity - quantity &lt;= 0:
            raise ValueError(f&#34;Product inventory is insufficient&#34;)

        existing_item = CartItems.query.filter_by(customer_id=customer_id, product_id=product_id).first()
        if existing_item:
            existing_item.quantity += quantity
            db.session.commit()
            return existing_item

        cart_item = CartItems(customer_id=customer.user_id, product_id=product.id, quantity=quantity)
        db.session.add(cart_item)
        db.session.commit()
        return cart_item

    def update_cart_item(self, cart_item_id, quantity):
        &#34;&#34;&#34;Set a cart item&#39;s quantity to a new positive value.

        Args:
            cart_item_id: Cart item primary key.
            quantity: Positive integer quantity to set.

        Returns:
            CartItems: The updated cart item.

        Raises:
            ValueError: If quantity is invalid or cart item is not found.
        &#34;&#34;&#34;
        if quantity &lt;= 0:
            raise ValueError(&#34;Quantity to add must be greater than zero&#34;)

        cart_item = CartItems.query.filter_by(id=cart_item_id).first()
        if not cart_item:
            raise ValueError(f&#34;Cart item {cart_item_id} not found&#34;)

        cart_item.quantity = quantity
        db.session.commit()
        return cart_item

    def delete_cart_item(self, cart_item_id):
        &#34;&#34;&#34;Remove a cart item by id.

        Args:
            cart_item_id: Cart item id.

        Returns:
            None

        Raises:
            ValueError: If the cart item is not found.
        &#34;&#34;&#34;
        cart_item = CartItems.query.filter_by(id=cart_item_id).first()
        if not cart_item:
            raise ValueError(f&#34;Cart item {cart_item_id} not found&#34;)

        db.session.delete(cart_item)
        db.session.commit()
        return

    def get_cart_items(self, customer_id):
        &#34;&#34;&#34;Return all cart items for a customer or None if empty.

        Args:
            customer_id: Customer&#39;s user id.

        Returns:
            list[CartItems] | None: List of items if any, else None.
        &#34;&#34;&#34;
        cart_items = CartItems.query.filter_by(customer_id=customer_id).all()
        if not cart_items:
            return None
        return cart_items

    def charge_payment_method(self, payment_method_id, total_price):
        &#34;&#34;&#34;Charge a payment method for the given amount if sufficient funds exist.

        Args:
            payment_method_id: Payment method id to charge.
            total_price: Decimal total amount to charge.

        Returns:
            bool: True if charged; False if insufficient funds.

        Raises:
            ValueError: If the payment method is not found.
        &#34;&#34;&#34;
        payment_method = PaymentMethods.query.filter_by(id=payment_method_id).first()
        if not payment_method:
            raise ValueError(f&#34;Payment Method {payment_method_id} not found&#34;)

        self.validate_customer(payment_method.customer_id)

        if payment_method.balance &lt; total_price:
            return False

        payment_method.balance -= total_price
        db.session.commit()
        return True

    def create_delivery(self, customer_showing_id, payment_method_id):
        &#34;&#34;&#34;Create a delivery for a booked showing after validating ownership and charging.

        This links the delivery to the customer&#39;s showing, verifies the payment method
        belongs to the same customer, creates delivery items from the cart, charges the
        payment method, decrements inventory, and attempts to assign a driver and staff.

        Args:
            customer_showing_id: CustomerShowings id for the booking.
            payment_method_id: PaymentMethods id to charge.

        Returns:
            Deliveries: The created delivery.

        Raises:
            ValueError: If duplicates exist, any referenced record is missing,
                the cart is empty, or funds are insufficient.
        &#34;&#34;&#34;
        customer_showing = CustomerShowings.query.filter_by(id=customer_showing_id).first()
        if not customer_showing:
            raise ValueError(f&#34;Customer showing {customer_showing_id} not found&#34;)
        self.validate_customer(customer_showing.customer_id)

        payment_method = PaymentMethods.query.filter_by(id=payment_method_id).first()
        if not payment_method:
            raise ValueError(f&#34;Payment method {payment_method_id} not found&#34;)
        if payment_method.customer_id != customer_showing.customer_id:
            raise ValueError(&#34;Payment method does not belong to this customer&#34;)

        seat = Seats.query.filter_by(id=customer_showing.seat_id).first()
        if not seat:
            raise ValueError(f&#34;Seat {customer_showing.seat_id} not found&#34;)

        auditorium = Auditoriums.query.filter_by(id=seat.auditorium_id).first()
        if not auditorium:
            raise ValueError(f&#34;Auditorium {seat.auditorium_id} not found&#34;)

        cart_items = self.get_cart_items(customer_id=customer_showing.customer_id)
        if not cart_items:
            raise ValueError(f&#34;Cart for {customer_showing.customer_id} is empty&#34;)

        total_price = self.calculate_total_price(cart_items=cart_items)

        delivery = Deliveries(
            driver_id=None,
            customer_showing_id=customer_showing.id,
            payment_method_id=payment_method.id,
            staff_id=None,
            total_price=total_price
        )
        db.session.add(delivery)
        db.session.flush()

        for item in cart_items:
            self.create_delivery_item(cart_item_id=item.id, delivery_id=delivery.id)

        was_charged = self.charge_payment_method(payment_method_id=payment_method.id, total_price=total_price)
        if not was_charged:
            db.session.rollback()
            raise ValueError(&#34;Insufficient funds&#34;)

        delivery.payment_status = &#39;completed&#39;

        for item in cart_items:
            product = Products.query.filter_by(id=item.product_id).first()
            product.inventory_quantity -= item.quantity

        # Attempt to assign driver and staff member (no-op if none available)
        self.driver_service.try_assign_driver(delivery=delivery)
        self.staff_service.try_assign_staff(theatre_id=auditorium.theatre_id, delivery=delivery)

        db.session.commit()
        return delivery

    def calculate_total_price(self, cart_items):
        &#34;&#34;&#34;Compute the total price for a list of cart items.

        Total is computed as sum of (unit_price - discount) * quantity for each item.

        Args:
            cart_items: Iterable of CartItems to price.

        Returns:
            Decimal: The total price as a Decimal.

        Raises:
            ValueError: If a cart item is invalid or references a missing product.
        &#34;&#34;&#34;
        total_price = decimal.Decimal(0.00)
        for item in cart_items:
            if item:
                product = Products.query.filter_by(id=item.product_id).first()
                if not product:
                    raise ValueError(f&#34;Product {item.product_id} not found&#34;)
                total_price += (product.unit_price - product.discount) * item.quantity
            else:
                raise ValueError(&#34;Invalid cart item&#34;)
        return total_price

    def create_delivery_item(self, cart_item_id, delivery_id):
        &#34;&#34;&#34;Create a DeliveryItems entry from a cart item for a pending delivery.

        Args:
            cart_item_id: Source cart item id.
            delivery_id: Target delivery id (must be pending).

        Returns:
            DeliveryItems: The created delivery-item record.

        Raises:
            ValueError: If cart item or delivery is missing, delivery not pending,
                or an identical delivery-item already exists.
        &#34;&#34;&#34;
        cart_item = CartItems.query.filter_by(id=cart_item_id).first()
        if not cart_item:
            raise ValueError(f&#34;Cart item {cart_item_id} not found&#34;)

        delivery = Deliveries.query.filter_by(id=delivery_id).first()
        if not delivery:
            raise ValueError(f&#34;Delivery {delivery_id} not found&#34;)

        if delivery.delivery_status != &#39;pending&#39;:
            raise ValueError(f&#34;Delivery must be pending to create delivery items&#34;)

        existing_delivery_item = DeliveryItems.query.filter_by(cart_item_id=cart_item.id, delivery_id=delivery.id).first()
        if existing_delivery_item:
            raise ValueError(f&#34;Delivery item {existing_delivery_item.id} already exists for cart item {cart_item.id}&#34;)

        delivery_item = DeliveryItems(cart_item_id=cart_item.id, delivery_id=delivery.id)
        db.session.add(delivery_item)
        db.session.commit()
        return delivery_item

    def cancel_delivery(self, delivery_id):
        &#34;&#34;&#34;Cancel a delivery, set driver availability, and refund the balance.

        Args:
            delivery_id: Delivery id to cancel.

        Returns:
            Deliveries: The cancelled delivery.

        Raises:
            ValueError: If the delivery is missing or already cancelled, or payment method cannot be found.
        &#34;&#34;&#34;
        delivery = Deliveries.query.filter_by(id=delivery_id).first()
        if not delivery:
            raise ValueError(f&#34;Delivery {delivery_id} not found&#34;)

        if delivery.delivery_status == &#39;cancelled&#39;:
            raise ValueError(f&#34;Delivery {delivery.id} is already cancelled&#34;)

        payment_method = PaymentMethods.query.filter_by(id=delivery.payment_method_id).first()
        if not payment_method:
            raise ValueError(f&#34;Payment method not found for {delivery.id}&#34;)

        payment_method.balance += delivery.total_price
        self.driver_service.update_driver_status(user_id=delivery.driver_id, new_status=&#39;available&#39;)
        delivery.delivery_status = &#39;cancelled&#39;
        db.session.commit()
        return delivery

    def rate_delivery(self, delivery_id, rating):
        &#34;&#34;&#34;Rate a fulfilled delivery and update the driver&#39;s average rating.

        Args:
            delivery_id: Delivery id to rate.
            rating: New rating value for the driver.

        Returns:
            Deliveries: The rated delivery (unchanged id and status; rating stored on driver).

        Raises:
            ValueError: If the underlying driver service rejects the rating.
        &#34;&#34;&#34;
        driver, delivery = self.driver_service.rate_driver(delivery_id=delivery_id, new_rating=rating)
        return delivery

    def show_all_products(self):
        &#34;&#34;&#34;List all available products across open suppliers, sorted by supplier and name.

        Returns:
            list[Products]: All available products ordered by supplier name and product name.
        &#34;&#34;&#34;
        products = Products.query.join(Suppliers, Products.supplier_id == Suppliers.user_id).filter(
            Products.is_available.is_(True)
        ).order_by(Suppliers.company_name.asc(), Products.name.asc()).all()
        return products

    def get_all_deliveries(self, user_id):
        &#34;&#34;&#34;List all deliveries for a customer (newest first).

        Args:
            user_id: Customer&#39;s user id.

        Returns:
            list[Deliveries]: Deliveries linked to the customer&#39;s showings.
        &#34;&#34;&#34;
        self.validate_customer(user_id=user_id)
        deliveries = Deliveries.query.join(
            CustomerShowings, Deliveries.customer_showing_id == CustomerShowings.id
        ).filter(
            CustomerShowings.customer_id == user_id
        ).order_by(
            Deliveries.id.desc()
        ).all()
        return deliveries

    def get_all_showings(self, user_id):
        &#34;&#34;&#34;Return showings booked by a customer with basic presentation details.

        Each result includes movie title, seat, ISO start time, auditorium label, and theatre name.

        Args:
            user_id: Customer&#39;s user id.

        Returns:
            list[dict]: Presentation dictionaries for each showing.
        &#34;&#34;&#34;
        self.validate_customer(user_id=user_id)
        showings = CustomerShowings.query.filter(CustomerShowings.customer_id == user_id).all()
        result = []
        for showing in showings:
            movie_showing = MovieShowings.query.filter_by(id=showing.movie_showing_id).first()
            movie = Movies.query.filter_by(id=movie_showing.movie_id).first()
            seat = Seats.query.filter_by(id=showing.seat_id).first()
            auditorium = (
                Auditoriums.query.filter_by(id=movie_showing.auditorium_id).first()
            )
            theatre = Theatres.query.filter_by(id=auditorium.theatre_id).first()
            start_time = None
            if movie_showing and getattr(movie_showing.start_time, &#34;isoformat&#34;, None):
                start_time = movie_showing.start_time.isoformat()
            elif movie_showing:
                start_time = str(movie_showing.start_time)
            else:
                start_time = None

            result.append({
                &#34;id&#34;: showing.id,
                &#34;movie_title&#34;: movie.title if movie else None,
                &#34;seat&#34;: f&#34;{seat.aisle} {seat.number}&#34;,
                &#34;start_time&#34;: start_time,
                &#34;auditorium&#34;: f&#34;Auditorium {auditorium.number}&#34; if auditorium else None,
                &#34;theatre_name&#34;: theatre.name
            })
        return result

    def get_delivery_details(self, delivery_id):
        &#34;&#34;&#34;Return expanded delivery details including items and associated theatre/movie.

        Args:
            delivery_id: Delivery id to expand.

        Returns:
            dict: A mapping containing ids, totals, timestamps, status, items, and venue/movie details.

        Raises:
            ValueError: If the delivery id is not found.
        &#34;&#34;&#34;
        delivery = Deliveries.query.filter_by(id=delivery_id).first()
        if not delivery:
            raise ValueError(f&#34;Delivery {delivery_id} not found&#34;)
        delivery_items = DeliveryItems.query.filter_by(delivery_id=delivery.id).all()
        cart_items = [CartItems.query.filter_by(id=item.cart_item_id).first() for item in delivery_items]
        items = [{&#34;name&#34;: Products.query.filter_by(id=item.product_id).first().name, &#34;quantity&#34;: item.quantity} for item in cart_items]
        customer_showing = CustomerShowings.query.filter_by(id=delivery.customer_showing_id).first()
        showing = MovieShowings.query.filter_by(id=customer_showing.movie_showing_id).first()
        movie = Movies.query.filter_by(id=showing.movie_id).first()
        auditorium = Auditoriums.query.filter_by(id=showing.auditorium_id).first()
        theatre = Theatres.query.filter_by(id=auditorium.theatre_id).first()
        return {
            &#34;id&#34;: delivery.id,
            &#34;driver_id&#34;: delivery.driver_id,
            &#34;total_price&#34;: float(delivery.total_price),
            &#34;delivery_time&#34;: delivery.delivery_time.isoformat() if delivery.delivery_time else None,
            &#34;delivery_status&#34;: delivery.delivery_status,
            &#34;items&#34;: items,
            &#34;theatre_name&#34;: theatre.name,
            &#34;theatre_address&#34;: theatre.address,
            &#34;movie_title&#34;: movie.title,
        }

    def get_customer_showing_id(self, user_id):
        &#34;&#34;&#34;
        Return the first customer showing id for a given customer.

        Looks up the first CustomerShowings record for the provided customer user_id
        and returns a minimal payload containing its id. Prints the id to stdout as
        a side effect.

        Args:
            user_id (int): The customer user&#39;s id to search by.

        Returns:
            dict: A dictionary with the key &#34;id&#34; mapped to the showing&#39;s integer id.

        Raises:
            AttributeError: If no CustomerShowings record exists for the given user_id.
        &#34;&#34;&#34;
        customer_showing = CustomerShowings.query.filter_by(customer_id=user_id).first()
        print(customer_showing.id)
        return {
            &#34;id&#34;: customer_showing.id,
        }</code></pre>
</details>
<div class="desc"><p>Customer service layer for accounts, payment methods, carts, showings, products, and deliveries.</p>
<p>This module centralizes customer-facing business logic on top of SQLAlchemy models,
and coordinates with user, staff, and driver services.</p>
<p>Initialize dependent services used by customer operations.</p></div>
<h3>Methods</h3>
<dl>
<dt id="services.customer_service.CustomerService.add_funds_to_payment_method"><code class="name flex">
<span>def <span class="ident">add_funds_to_payment_method</span></span>(<span>self, payment_method_id, amount)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_funds_to_payment_method(self, payment_method_id, amount):
    &#34;&#34;&#34;Increase a payment method&#39;s balance.

    Args:
        payment_method_id: Payment method id.
        amount: Positive decimal amount to add.

    Returns:
        PaymentMethods: The updated payment method.

    Raises:
        ValueError: If amount is not greater than zero or method not found.
    &#34;&#34;&#34;
    if amount &lt;= 0.00:
        raise ValueError(&#34;Amount to add must be greater than zero&#34;)

    payment_method = PaymentMethods.query.filter_by(id=payment_method_id).first()
    if not payment_method:
        raise ValueError(&#34;Payment method not found&#34;)

    payment_method.balance += decimal.Decimal(amount)
    db.session.commit()
    return payment_method</code></pre>
</details>
<div class="desc"><p>Increase a payment method's balance.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>payment_method_id</code></strong></dt>
<dd>Payment method id.</dd>
<dt><strong><code>amount</code></strong></dt>
<dd>Positive decimal amount to add.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>PaymentMethods</code></dt>
<dd>The updated payment method.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If amount is not greater than zero or method not found.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.add_payment_method"><code class="name flex">
<span>def <span class="ident">add_payment_method</span></span>(<span>self,<br>user_id,<br>card_number,<br>expiration_month,<br>expiration_year,<br>billing_address,<br>balance,<br>is_default)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_payment_method(self, user_id, card_number, expiration_month, expiration_year, billing_address, balance, is_default):
    &#34;&#34;&#34;Add a new payment method for a customer.

    Args:
        user_id: Customer&#39;s user id.
        card_number: 16-character card number string.
        expiration_month: Integer month 1–12.
        expiration_year: Four-digit expiration year.
        billing_address: Billing address string.
        balance: Initial stored balance for testing/demo.
        is_default: Whether this card is the default.

    Returns:
        PaymentMethods: The created payment method.

    Raises:
        ValueError: If a duplicate payment method exists for the same card and expiry.
    &#34;&#34;&#34;
    customer = self.get_customer(user_id=user_id)
    existing_payment_method = PaymentMethods.query.filter_by(
        customer_id=customer.user_id,
        card_number=card_number,
        expiration_month=expiration_month,
        expiration_year=expiration_year
    ).first()
    if existing_payment_method:
        raise ValueError(&#34;Payment method already exists for this user&#34;)

    payment_method = PaymentMethods(
        customer_id=customer.user_id,
        card_number=card_number,
        expiration_month=expiration_month,
        expiration_year=expiration_year,
        billing_address=billing_address,
        balance=balance,
        is_default=is_default
    )
    db.session.add(payment_method)
    db.session.commit()
    return payment_method</code></pre>
</details>
<div class="desc"><p>Add a new payment method for a customer.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user_id</code></strong></dt>
<dd>Customer's user id.</dd>
<dt><strong><code>card_number</code></strong></dt>
<dd>16-character card number string.</dd>
<dt><strong><code>expiration_month</code></strong></dt>
<dd>Integer month 1–12.</dd>
<dt><strong><code>expiration_year</code></strong></dt>
<dd>Four-digit expiration year.</dd>
<dt><strong><code>billing_address</code></strong></dt>
<dd>Billing address string.</dd>
<dt><strong><code>balance</code></strong></dt>
<dd>Initial stored balance for testing/demo.</dd>
<dt><strong><code>is_default</code></strong></dt>
<dd>Whether this card is the default.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>PaymentMethods</code></dt>
<dd>The created payment method.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If a duplicate payment method exists for the same card and expiry.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.calculate_total_price"><code class="name flex">
<span>def <span class="ident">calculate_total_price</span></span>(<span>self, cart_items)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def calculate_total_price(self, cart_items):
    &#34;&#34;&#34;Compute the total price for a list of cart items.

    Total is computed as sum of (unit_price - discount) * quantity for each item.

    Args:
        cart_items: Iterable of CartItems to price.

    Returns:
        Decimal: The total price as a Decimal.

    Raises:
        ValueError: If a cart item is invalid or references a missing product.
    &#34;&#34;&#34;
    total_price = decimal.Decimal(0.00)
    for item in cart_items:
        if item:
            product = Products.query.filter_by(id=item.product_id).first()
            if not product:
                raise ValueError(f&#34;Product {item.product_id} not found&#34;)
            total_price += (product.unit_price - product.discount) * item.quantity
        else:
            raise ValueError(&#34;Invalid cart item&#34;)
    return total_price</code></pre>
</details>
<div class="desc"><p>Compute the total price for a list of cart items.</p>
<p>Total is computed as sum of (unit_price - discount) * quantity for each item.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>cart_items</code></strong></dt>
<dd>Iterable of CartItems to price.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Decimal</code></dt>
<dd>The total price as a Decimal.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If a cart item is invalid or references a missing product.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.cancel_delivery"><code class="name flex">
<span>def <span class="ident">cancel_delivery</span></span>(<span>self, delivery_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def cancel_delivery(self, delivery_id):
    &#34;&#34;&#34;Cancel a delivery, set driver availability, and refund the balance.

    Args:
        delivery_id: Delivery id to cancel.

    Returns:
        Deliveries: The cancelled delivery.

    Raises:
        ValueError: If the delivery is missing or already cancelled, or payment method cannot be found.
    &#34;&#34;&#34;
    delivery = Deliveries.query.filter_by(id=delivery_id).first()
    if not delivery:
        raise ValueError(f&#34;Delivery {delivery_id} not found&#34;)

    if delivery.delivery_status == &#39;cancelled&#39;:
        raise ValueError(f&#34;Delivery {delivery.id} is already cancelled&#34;)

    payment_method = PaymentMethods.query.filter_by(id=delivery.payment_method_id).first()
    if not payment_method:
        raise ValueError(f&#34;Payment method not found for {delivery.id}&#34;)

    payment_method.balance += delivery.total_price
    self.driver_service.update_driver_status(user_id=delivery.driver_id, new_status=&#39;available&#39;)
    delivery.delivery_status = &#39;cancelled&#39;
    db.session.commit()
    return delivery</code></pre>
</details>
<div class="desc"><p>Cancel a delivery, set driver availability, and refund the balance.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>delivery_id</code></strong></dt>
<dd>Delivery id to cancel.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Deliveries</code></dt>
<dd>The cancelled delivery.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If the delivery is missing or already cancelled, or payment method cannot be found.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.charge_payment_method"><code class="name flex">
<span>def <span class="ident">charge_payment_method</span></span>(<span>self, payment_method_id, total_price)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def charge_payment_method(self, payment_method_id, total_price):
    &#34;&#34;&#34;Charge a payment method for the given amount if sufficient funds exist.

    Args:
        payment_method_id: Payment method id to charge.
        total_price: Decimal total amount to charge.

    Returns:
        bool: True if charged; False if insufficient funds.

    Raises:
        ValueError: If the payment method is not found.
    &#34;&#34;&#34;
    payment_method = PaymentMethods.query.filter_by(id=payment_method_id).first()
    if not payment_method:
        raise ValueError(f&#34;Payment Method {payment_method_id} not found&#34;)

    self.validate_customer(payment_method.customer_id)

    if payment_method.balance &lt; total_price:
        return False

    payment_method.balance -= total_price
    db.session.commit()
    return True</code></pre>
</details>
<div class="desc"><p>Charge a payment method for the given amount if sufficient funds exist.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>payment_method_id</code></strong></dt>
<dd>Payment method id to charge.</dd>
<dt><strong><code>total_price</code></strong></dt>
<dd>Decimal total amount to charge.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>bool</code></dt>
<dd>True if charged; False if insufficient funds.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If the payment method is not found.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.create_cart_item"><code class="name flex">
<span>def <span class="ident">create_cart_item</span></span>(<span>self, customer_id, product_id, quantity)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_cart_item(self, customer_id, product_id, quantity):
    &#34;&#34;&#34;Add a product to the cart or increment quantity if it already exists.

    Args:
        customer_id: Customer&#39;s user id.
        product_id: Product id to add.
        quantity: Positive integer quantity to add.

    Returns:
        CartItems: The created or updated cart item.

    Raises:
        ValueError: If quantity is invalid, product is not found, or insufficient inventory.
    &#34;&#34;&#34;
    if quantity &lt;= 0:
        raise ValueError(&#34;Quantity to add must be greater than zero&#34;)

    customer = self.get_customer(user_id=customer_id)
    product = Products.query.filter_by(id=product_id).first()
    if not product:
        raise ValueError(f&#34;Product {product_id} not found&#34;)

    if product.inventory_quantity - quantity &lt;= 0:
        raise ValueError(f&#34;Product inventory is insufficient&#34;)

    existing_item = CartItems.query.filter_by(customer_id=customer_id, product_id=product_id).first()
    if existing_item:
        existing_item.quantity += quantity
        db.session.commit()
        return existing_item

    cart_item = CartItems(customer_id=customer.user_id, product_id=product.id, quantity=quantity)
    db.session.add(cart_item)
    db.session.commit()
    return cart_item</code></pre>
</details>
<div class="desc"><p>Add a product to the cart or increment quantity if it already exists.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>customer_id</code></strong></dt>
<dd>Customer's user id.</dd>
<dt><strong><code>product_id</code></strong></dt>
<dd>Product id to add.</dd>
<dt><strong><code>quantity</code></strong></dt>
<dd>Positive integer quantity to add.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>CartItems</code></dt>
<dd>The created or updated cart item.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If quantity is invalid, product is not found, or insufficient inventory.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.create_customer"><code class="name flex">
<span>def <span class="ident">create_customer</span></span>(<span>self, name, email, phone, birthday, password, role, default_theatre_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_customer(self, name, email, phone, birthday, password, role, default_theatre_id):
    &#34;&#34;&#34;Create a user with the customer role and a matching customer profile.

    Args:
        name: Customer full name.
        email: Unique email address.
        phone: Unique phone number.
        birthday: Date of birth (YYYY-MM-DD or date).
        password: Plaintext password to hash and store.
        role: Must be &#39;customer&#39;.
        default_theatre_id: Theatre id to set as the customer&#39;s default.

    Returns:
        Customers: The newly created customer profile.

    Raises:
        ValueError: If role is not &#39;customer&#39; or the theatre id is invalid.
    &#34;&#34;&#34;
    if role != &#39;customer&#39;:
        raise ValueError(&#34;User role is not &#39;customer&#39;&#34;)

    user = self.user_service.create_user(
        name=name,
        email=email,
        phone=phone,
        birthday=birthday,
        password=password,
        role=role
    )

    theatre = Theatres.query.filter_by(id=default_theatre_id).first()
    if not theatre:
        raise ValueError(f&#34;Theatre {default_theatre_id} not found&#34;)

    customer = Customers(user_id=user.id, default_theatre_id=default_theatre_id)
    db.session.add(customer)
    db.session.commit()
    return customer</code></pre>
</details>
<div class="desc"><p>Create a user with the customer role and a matching customer profile.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>name</code></strong></dt>
<dd>Customer full name.</dd>
<dt><strong><code>email</code></strong></dt>
<dd>Unique email address.</dd>
<dt><strong><code>phone</code></strong></dt>
<dd>Unique phone number.</dd>
<dt><strong><code>birthday</code></strong></dt>
<dd>Date of birth (YYYY-MM-DD or date).</dd>
<dt><strong><code>password</code></strong></dt>
<dd>Plaintext password to hash and store.</dd>
<dt><strong><code>role</code></strong></dt>
<dd>Must be 'customer'.</dd>
<dt><strong><code>default_theatre_id</code></strong></dt>
<dd>Theatre id to set as the customer's default.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Customers</code></dt>
<dd>The newly created customer profile.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If role is not 'customer' or the theatre id is invalid.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.create_customer_showing"><code class="name flex">
<span>def <span class="ident">create_customer_showing</span></span>(<span>self, user_id, movie_showing_id, seat_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_customer_showing(self, user_id, movie_showing_id, seat_id):
    &#34;&#34;&#34;Book a seat for a specific movie showing for a customer.

    Args:
        user_id: Customer&#39;s user id.
        movie_showing_id: Target MovieShowings id.
        seat_id: Target seat id in the showing&#39;s auditorium.

    Returns:
        CustomerShowings: The created booking record.

    Raises:
        ValueError: If customer, showing, seat is missing, or a duplicate booking exists.
    &#34;&#34;&#34;
    customer = self.get_customer(user_id=user_id)
    movie_showing = MovieShowings.query.filter_by(id=movie_showing_id).first()
    if not movie_showing:
        raise ValueError(f&#34;Movie Showing {movie_showing_id} not found&#34;)

    seat = Seats.query.filter_by(id=seat_id).first()
    if not seat:
        raise ValueError(f&#34;Seat {seat_id} not found&#34;)

    existing_showing = CustomerShowings.query.filter_by(
        customer_id=customer.user_id,
        movie_showing_id=movie_showing.id,
        seat_id=seat.id
    ).first()
    if existing_showing:
        raise ValueError(f&#34;Identical customer showing found&#34;)

    customer_showing = CustomerShowings(
        customer_id=customer.user_id,
        movie_showing_id=movie_showing.id,
        seat_id=seat.id
    )
    db.session.add(customer_showing)
    db.session.commit()
    return customer_showing</code></pre>
</details>
<div class="desc"><p>Book a seat for a specific movie showing for a customer.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user_id</code></strong></dt>
<dd>Customer's user id.</dd>
<dt><strong><code>movie_showing_id</code></strong></dt>
<dd>Target MovieShowings id.</dd>
<dt><strong><code>seat_id</code></strong></dt>
<dd>Target seat id in the showing's auditorium.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>CustomerShowings</code></dt>
<dd>The created booking record.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If customer, showing, seat is missing, or a duplicate booking exists.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.create_delivery"><code class="name flex">
<span>def <span class="ident">create_delivery</span></span>(<span>self, customer_showing_id, payment_method_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_delivery(self, customer_showing_id, payment_method_id):
    &#34;&#34;&#34;Create a delivery for a booked showing after validating ownership and charging.

    This links the delivery to the customer&#39;s showing, verifies the payment method
    belongs to the same customer, creates delivery items from the cart, charges the
    payment method, decrements inventory, and attempts to assign a driver and staff.

    Args:
        customer_showing_id: CustomerShowings id for the booking.
        payment_method_id: PaymentMethods id to charge.

    Returns:
        Deliveries: The created delivery.

    Raises:
        ValueError: If duplicates exist, any referenced record is missing,
            the cart is empty, or funds are insufficient.
    &#34;&#34;&#34;
    customer_showing = CustomerShowings.query.filter_by(id=customer_showing_id).first()
    if not customer_showing:
        raise ValueError(f&#34;Customer showing {customer_showing_id} not found&#34;)
    self.validate_customer(customer_showing.customer_id)

    payment_method = PaymentMethods.query.filter_by(id=payment_method_id).first()
    if not payment_method:
        raise ValueError(f&#34;Payment method {payment_method_id} not found&#34;)
    if payment_method.customer_id != customer_showing.customer_id:
        raise ValueError(&#34;Payment method does not belong to this customer&#34;)

    seat = Seats.query.filter_by(id=customer_showing.seat_id).first()
    if not seat:
        raise ValueError(f&#34;Seat {customer_showing.seat_id} not found&#34;)

    auditorium = Auditoriums.query.filter_by(id=seat.auditorium_id).first()
    if not auditorium:
        raise ValueError(f&#34;Auditorium {seat.auditorium_id} not found&#34;)

    cart_items = self.get_cart_items(customer_id=customer_showing.customer_id)
    if not cart_items:
        raise ValueError(f&#34;Cart for {customer_showing.customer_id} is empty&#34;)

    total_price = self.calculate_total_price(cart_items=cart_items)

    delivery = Deliveries(
        driver_id=None,
        customer_showing_id=customer_showing.id,
        payment_method_id=payment_method.id,
        staff_id=None,
        total_price=total_price
    )
    db.session.add(delivery)
    db.session.flush()

    for item in cart_items:
        self.create_delivery_item(cart_item_id=item.id, delivery_id=delivery.id)

    was_charged = self.charge_payment_method(payment_method_id=payment_method.id, total_price=total_price)
    if not was_charged:
        db.session.rollback()
        raise ValueError(&#34;Insufficient funds&#34;)

    delivery.payment_status = &#39;completed&#39;

    for item in cart_items:
        product = Products.query.filter_by(id=item.product_id).first()
        product.inventory_quantity -= item.quantity

    # Attempt to assign driver and staff member (no-op if none available)
    self.driver_service.try_assign_driver(delivery=delivery)
    self.staff_service.try_assign_staff(theatre_id=auditorium.theatre_id, delivery=delivery)

    db.session.commit()
    return delivery</code></pre>
</details>
<div class="desc"><p>Create a delivery for a booked showing after validating ownership and charging.</p>
<p>This links the delivery to the customer's showing, verifies the payment method
belongs to the same customer, creates delivery items from the cart, charges the
payment method, decrements inventory, and attempts to assign a driver and staff.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>customer_showing_id</code></strong></dt>
<dd>CustomerShowings id for the booking.</dd>
<dt><strong><code>payment_method_id</code></strong></dt>
<dd>PaymentMethods id to charge.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Deliveries</code></dt>
<dd>The created delivery.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If duplicates exist, any referenced record is missing,
the cart is empty, or funds are insufficient.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.create_delivery_item"><code class="name flex">
<span>def <span class="ident">create_delivery_item</span></span>(<span>self, cart_item_id, delivery_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_delivery_item(self, cart_item_id, delivery_id):
    &#34;&#34;&#34;Create a DeliveryItems entry from a cart item for a pending delivery.

    Args:
        cart_item_id: Source cart item id.
        delivery_id: Target delivery id (must be pending).

    Returns:
        DeliveryItems: The created delivery-item record.

    Raises:
        ValueError: If cart item or delivery is missing, delivery not pending,
            or an identical delivery-item already exists.
    &#34;&#34;&#34;
    cart_item = CartItems.query.filter_by(id=cart_item_id).first()
    if not cart_item:
        raise ValueError(f&#34;Cart item {cart_item_id} not found&#34;)

    delivery = Deliveries.query.filter_by(id=delivery_id).first()
    if not delivery:
        raise ValueError(f&#34;Delivery {delivery_id} not found&#34;)

    if delivery.delivery_status != &#39;pending&#39;:
        raise ValueError(f&#34;Delivery must be pending to create delivery items&#34;)

    existing_delivery_item = DeliveryItems.query.filter_by(cart_item_id=cart_item.id, delivery_id=delivery.id).first()
    if existing_delivery_item:
        raise ValueError(f&#34;Delivery item {existing_delivery_item.id} already exists for cart item {cart_item.id}&#34;)

    delivery_item = DeliveryItems(cart_item_id=cart_item.id, delivery_id=delivery.id)
    db.session.add(delivery_item)
    db.session.commit()
    return delivery_item</code></pre>
</details>
<div class="desc"><p>Create a DeliveryItems entry from a cart item for a pending delivery.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>cart_item_id</code></strong></dt>
<dd>Source cart item id.</dd>
<dt><strong><code>delivery_id</code></strong></dt>
<dd>Target delivery id (must be pending).</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>DeliveryItems</code></dt>
<dd>The created delivery-item record.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If cart item or delivery is missing, delivery not pending,
or an identical delivery-item already exists.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.delete_cart_item"><code class="name flex">
<span>def <span class="ident">delete_cart_item</span></span>(<span>self, cart_item_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def delete_cart_item(self, cart_item_id):
    &#34;&#34;&#34;Remove a cart item by id.

    Args:
        cart_item_id: Cart item id.

    Returns:
        None

    Raises:
        ValueError: If the cart item is not found.
    &#34;&#34;&#34;
    cart_item = CartItems.query.filter_by(id=cart_item_id).first()
    if not cart_item:
        raise ValueError(f&#34;Cart item {cart_item_id} not found&#34;)

    db.session.delete(cart_item)
    db.session.commit()
    return</code></pre>
</details>
<div class="desc"><p>Remove a cart item by id.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>cart_item_id</code></strong></dt>
<dd>Cart item id.</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>None</p>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If the cart item is not found.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.delete_customer"><code class="name flex">
<span>def <span class="ident">delete_customer</span></span>(<span>self, user_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def delete_customer(self, user_id):
    &#34;&#34;&#34;Delete a customer by removing the underlying user.

    Args:
        user_id: Customer&#39;s user id.

    Returns:
        None

    Raises:
        ValueError: If the customer does not exist.
    &#34;&#34;&#34;
    customer = self.get_customer(user_id=user_id)
    self.user_service.delete_user(user_id=customer.user_id)</code></pre>
</details>
<div class="desc"><p>Delete a customer by removing the underlying user.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user_id</code></strong></dt>
<dd>Customer's user id.</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>None</p>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If the customer does not exist.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.delete_payment_method"><code class="name flex">
<span>def <span class="ident">delete_payment_method</span></span>(<span>self, payment_method_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def delete_payment_method(self, payment_method_id):
    &#34;&#34;&#34;Remove a payment method by id.

    Args:
        payment_method_id: Payment method primary key.

    Returns:
        bool: True if deleted.

    Raises:
        ValueError: If the payment method does not exist.
    &#34;&#34;&#34;
    payment_method = PaymentMethods.query.filter_by(id=payment_method_id).first()
    if not payment_method:
        raise ValueError(&#34;Payment method not found&#34;)

    db.session.delete(payment_method)
    db.session.commit()
    return True</code></pre>
</details>
<div class="desc"><p>Remove a payment method by id.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>payment_method_id</code></strong></dt>
<dd>Payment method primary key.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>bool</code></dt>
<dd>True if deleted.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If the payment method does not exist.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.get_all_deliveries"><code class="name flex">
<span>def <span class="ident">get_all_deliveries</span></span>(<span>self, user_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_all_deliveries(self, user_id):
    &#34;&#34;&#34;List all deliveries for a customer (newest first).

    Args:
        user_id: Customer&#39;s user id.

    Returns:
        list[Deliveries]: Deliveries linked to the customer&#39;s showings.
    &#34;&#34;&#34;
    self.validate_customer(user_id=user_id)
    deliveries = Deliveries.query.join(
        CustomerShowings, Deliveries.customer_showing_id == CustomerShowings.id
    ).filter(
        CustomerShowings.customer_id == user_id
    ).order_by(
        Deliveries.id.desc()
    ).all()
    return deliveries</code></pre>
</details>
<div class="desc"><p>List all deliveries for a customer (newest first).</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user_id</code></strong></dt>
<dd>Customer's user id.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list[Deliveries]</code></dt>
<dd>Deliveries linked to the customer's showings.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.get_all_showings"><code class="name flex">
<span>def <span class="ident">get_all_showings</span></span>(<span>self, user_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_all_showings(self, user_id):
    &#34;&#34;&#34;Return showings booked by a customer with basic presentation details.

    Each result includes movie title, seat, ISO start time, auditorium label, and theatre name.

    Args:
        user_id: Customer&#39;s user id.

    Returns:
        list[dict]: Presentation dictionaries for each showing.
    &#34;&#34;&#34;
    self.validate_customer(user_id=user_id)
    showings = CustomerShowings.query.filter(CustomerShowings.customer_id == user_id).all()
    result = []
    for showing in showings:
        movie_showing = MovieShowings.query.filter_by(id=showing.movie_showing_id).first()
        movie = Movies.query.filter_by(id=movie_showing.movie_id).first()
        seat = Seats.query.filter_by(id=showing.seat_id).first()
        auditorium = (
            Auditoriums.query.filter_by(id=movie_showing.auditorium_id).first()
        )
        theatre = Theatres.query.filter_by(id=auditorium.theatre_id).first()
        start_time = None
        if movie_showing and getattr(movie_showing.start_time, &#34;isoformat&#34;, None):
            start_time = movie_showing.start_time.isoformat()
        elif movie_showing:
            start_time = str(movie_showing.start_time)
        else:
            start_time = None

        result.append({
            &#34;id&#34;: showing.id,
            &#34;movie_title&#34;: movie.title if movie else None,
            &#34;seat&#34;: f&#34;{seat.aisle} {seat.number}&#34;,
            &#34;start_time&#34;: start_time,
            &#34;auditorium&#34;: f&#34;Auditorium {auditorium.number}&#34; if auditorium else None,
            &#34;theatre_name&#34;: theatre.name
        })
    return result</code></pre>
</details>
<div class="desc"><p>Return showings booked by a customer with basic presentation details.</p>
<p>Each result includes movie title, seat, ISO start time, auditorium label, and theatre name.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user_id</code></strong></dt>
<dd>Customer's user id.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list[dict]</code></dt>
<dd>Presentation dictionaries for each showing.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.get_cart_items"><code class="name flex">
<span>def <span class="ident">get_cart_items</span></span>(<span>self, customer_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_cart_items(self, customer_id):
    &#34;&#34;&#34;Return all cart items for a customer or None if empty.

    Args:
        customer_id: Customer&#39;s user id.

    Returns:
        list[CartItems] | None: List of items if any, else None.
    &#34;&#34;&#34;
    cart_items = CartItems.query.filter_by(customer_id=customer_id).all()
    if not cart_items:
        return None
    return cart_items</code></pre>
</details>
<div class="desc"><p>Return all cart items for a customer or None if empty.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>customer_id</code></strong></dt>
<dd>Customer's user id.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list[CartItems] | None</code></dt>
<dd>List of items if any, else None.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.get_customer"><code class="name flex">
<span>def <span class="ident">get_customer</span></span>(<span>self, user_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_customer(self, user_id):
    &#34;&#34;&#34;Fetch the customer record for a given user id.

    Args:
        user_id: The user id to look up.

    Returns:
        Customers: The customer record.
    &#34;&#34;&#34;
    customer = self.validate_customer(user_id=user_id)
    return customer</code></pre>
</details>
<div class="desc"><p>Fetch the customer record for a given user id.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user_id</code></strong></dt>
<dd>The user id to look up.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Customers</code></dt>
<dd>The customer record.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.get_customer_payment_methods"><code class="name flex">
<span>def <span class="ident">get_customer_payment_methods</span></span>(<span>self, customer_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_customer_payment_methods(self, customer_id):
    &#34;&#34;&#34;List all payment methods for a customer.

    Args:
        customer_id: Customer&#39;s user id.

    Returns:
        list[PaymentMethods]: All payment methods for the customer (possibly empty).
    &#34;&#34;&#34;
    payment_methods = PaymentMethods.query.filter(PaymentMethods.customer_id == customer_id).all()
    return payment_methods</code></pre>
</details>
<div class="desc"><p>List all payment methods for a customer.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>customer_id</code></strong></dt>
<dd>Customer's user id.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list[PaymentMethods]</code></dt>
<dd>All payment methods for the customer (possibly empty).</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.get_customer_showing_id"><code class="name flex">
<span>def <span class="ident">get_customer_showing_id</span></span>(<span>self, user_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_customer_showing_id(self, user_id):
    &#34;&#34;&#34;
    Return the first customer showing id for a given customer.

    Looks up the first CustomerShowings record for the provided customer user_id
    and returns a minimal payload containing its id. Prints the id to stdout as
    a side effect.

    Args:
        user_id (int): The customer user&#39;s id to search by.

    Returns:
        dict: A dictionary with the key &#34;id&#34; mapped to the showing&#39;s integer id.

    Raises:
        AttributeError: If no CustomerShowings record exists for the given user_id.
    &#34;&#34;&#34;
    customer_showing = CustomerShowings.query.filter_by(customer_id=user_id).first()
    print(customer_showing.id)
    return {
        &#34;id&#34;: customer_showing.id,
    }</code></pre>
</details>
<div class="desc"><p>Return the first customer showing id for a given customer.</p>
<p>Looks up the first CustomerShowings record for the provided customer user_id
and returns a minimal payload containing its id. Prints the id to stdout as
a side effect.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user_id</code></strong> :&ensp;<code>int</code></dt>
<dd>The customer user's id to search by.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>dict</code></dt>
<dd>A dictionary with the key "id" mapped to the showing's integer id.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>AttributeError</code></dt>
<dd>If no CustomerShowings record exists for the given user_id.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.get_delivery_details"><code class="name flex">
<span>def <span class="ident">get_delivery_details</span></span>(<span>self, delivery_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_delivery_details(self, delivery_id):
    &#34;&#34;&#34;Return expanded delivery details including items and associated theatre/movie.

    Args:
        delivery_id: Delivery id to expand.

    Returns:
        dict: A mapping containing ids, totals, timestamps, status, items, and venue/movie details.

    Raises:
        ValueError: If the delivery id is not found.
    &#34;&#34;&#34;
    delivery = Deliveries.query.filter_by(id=delivery_id).first()
    if not delivery:
        raise ValueError(f&#34;Delivery {delivery_id} not found&#34;)
    delivery_items = DeliveryItems.query.filter_by(delivery_id=delivery.id).all()
    cart_items = [CartItems.query.filter_by(id=item.cart_item_id).first() for item in delivery_items]
    items = [{&#34;name&#34;: Products.query.filter_by(id=item.product_id).first().name, &#34;quantity&#34;: item.quantity} for item in cart_items]
    customer_showing = CustomerShowings.query.filter_by(id=delivery.customer_showing_id).first()
    showing = MovieShowings.query.filter_by(id=customer_showing.movie_showing_id).first()
    movie = Movies.query.filter_by(id=showing.movie_id).first()
    auditorium = Auditoriums.query.filter_by(id=showing.auditorium_id).first()
    theatre = Theatres.query.filter_by(id=auditorium.theatre_id).first()
    return {
        &#34;id&#34;: delivery.id,
        &#34;driver_id&#34;: delivery.driver_id,
        &#34;total_price&#34;: float(delivery.total_price),
        &#34;delivery_time&#34;: delivery.delivery_time.isoformat() if delivery.delivery_time else None,
        &#34;delivery_status&#34;: delivery.delivery_status,
        &#34;items&#34;: items,
        &#34;theatre_name&#34;: theatre.name,
        &#34;theatre_address&#34;: theatre.address,
        &#34;movie_title&#34;: movie.title,
    }</code></pre>
</details>
<div class="desc"><p>Return expanded delivery details including items and associated theatre/movie.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>delivery_id</code></strong></dt>
<dd>Delivery id to expand.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>dict</code></dt>
<dd>A mapping containing ids, totals, timestamps, status, items, and venue/movie details.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If the delivery id is not found.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.rate_delivery"><code class="name flex">
<span>def <span class="ident">rate_delivery</span></span>(<span>self, delivery_id, rating)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def rate_delivery(self, delivery_id, rating):
    &#34;&#34;&#34;Rate a fulfilled delivery and update the driver&#39;s average rating.

    Args:
        delivery_id: Delivery id to rate.
        rating: New rating value for the driver.

    Returns:
        Deliveries: The rated delivery (unchanged id and status; rating stored on driver).

    Raises:
        ValueError: If the underlying driver service rejects the rating.
    &#34;&#34;&#34;
    driver, delivery = self.driver_service.rate_driver(delivery_id=delivery_id, new_rating=rating)
    return delivery</code></pre>
</details>
<div class="desc"><p>Rate a fulfilled delivery and update the driver's average rating.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>delivery_id</code></strong></dt>
<dd>Delivery id to rate.</dd>
<dt><strong><code>rating</code></strong></dt>
<dd>New rating value for the driver.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Deliveries</code></dt>
<dd>The rated delivery (unchanged id and status; rating stored on driver).</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If the underlying driver service rejects the rating.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.show_all_products"><code class="name flex">
<span>def <span class="ident">show_all_products</span></span>(<span>self)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def show_all_products(self):
    &#34;&#34;&#34;List all available products across open suppliers, sorted by supplier and name.

    Returns:
        list[Products]: All available products ordered by supplier name and product name.
    &#34;&#34;&#34;
    products = Products.query.join(Suppliers, Products.supplier_id == Suppliers.user_id).filter(
        Products.is_available.is_(True)
    ).order_by(Suppliers.company_name.asc(), Products.name.asc()).all()
    return products</code></pre>
</details>
<div class="desc"><p>List all available products across open suppliers, sorted by supplier and name.</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list[Products]</code></dt>
<dd>All available products ordered by supplier name and product name.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.update_cart_item"><code class="name flex">
<span>def <span class="ident">update_cart_item</span></span>(<span>self, cart_item_id, quantity)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def update_cart_item(self, cart_item_id, quantity):
    &#34;&#34;&#34;Set a cart item&#39;s quantity to a new positive value.

    Args:
        cart_item_id: Cart item primary key.
        quantity: Positive integer quantity to set.

    Returns:
        CartItems: The updated cart item.

    Raises:
        ValueError: If quantity is invalid or cart item is not found.
    &#34;&#34;&#34;
    if quantity &lt;= 0:
        raise ValueError(&#34;Quantity to add must be greater than zero&#34;)

    cart_item = CartItems.query.filter_by(id=cart_item_id).first()
    if not cart_item:
        raise ValueError(f&#34;Cart item {cart_item_id} not found&#34;)

    cart_item.quantity = quantity
    db.session.commit()
    return cart_item</code></pre>
</details>
<div class="desc"><p>Set a cart item's quantity to a new positive value.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>cart_item_id</code></strong></dt>
<dd>Cart item primary key.</dd>
<dt><strong><code>quantity</code></strong></dt>
<dd>Positive integer quantity to set.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>CartItems</code></dt>
<dd>The updated cart item.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If quantity is invalid or cart item is not found.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.update_default_theatre"><code class="name flex">
<span>def <span class="ident">update_default_theatre</span></span>(<span>self, user_id, new_theatre_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def update_default_theatre(self, user_id, new_theatre_id):
    &#34;&#34;&#34;Set a customer&#39;s default theatre.

    Args:
        user_id: Customer&#39;s user id.
        new_theatre_id: Theatre id to set as default.

    Returns:
        Customers: The updated customer record.

    Raises:
        ValueError: If customer or theatre is not found.
    &#34;&#34;&#34;
    customer = self.get_customer(user_id=user_id)
    theatre = Theatres.query.filter_by(id=new_theatre_id).first()
    if not theatre:
        raise ValueError(f&#34;Theatre {new_theatre_id} not found&#34;)

    customer.default_theatre_id = theatre.id
    db.session.commit()
    return customer</code></pre>
</details>
<div class="desc"><p>Set a customer's default theatre.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user_id</code></strong></dt>
<dd>Customer's user id.</dd>
<dt><strong><code>new_theatre_id</code></strong></dt>
<dd>Theatre id to set as default.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Customers</code></dt>
<dd>The updated customer record.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If customer or theatre is not found.</dd>
</dl></div>
</dd>
<dt id="services.customer_service.CustomerService.validate_customer"><code class="name flex">
<span>def <span class="ident">validate_customer</span></span>(<span>self, user_id)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def validate_customer(self, user_id):
    &#34;&#34;&#34;Ensure the given user_id belongs to a customer.

    Args:
        user_id: The user id to validate.

    Returns:
        Customers: The customer record associated with user_id.

    Raises:
        ValueError: If no customer exists for the given user_id.
    &#34;&#34;&#34;
    customer = Customers.query.filter_by(user_id=user_id).first()
    if not customer:
        raise ValueError(f&#34;Customer {user_id} not found&#34;)
    return customer</code></pre>
</details>
<div class="desc"><p>Ensure the given user_id belongs to a customer.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user_id</code></strong></dt>
<dd>The user id to validate.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Customers</code></dt>
<dd>The customer record associated with user_id.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If no customer exists for the given user_id.</dd>
</dl></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="services" href="index.html">services</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="services.customer_service.CustomerService" href="#services.customer_service.CustomerService">CustomerService</a></code></h4>
<ul class="">
<li><code><a title="services.customer_service.CustomerService.add_funds_to_payment_method" href="#services.customer_service.CustomerService.add_funds_to_payment_method">add_funds_to_payment_method</a></code></li>
<li><code><a title="services.customer_service.CustomerService.add_payment_method" href="#services.customer_service.CustomerService.add_payment_method">add_payment_method</a></code></li>
<li><code><a title="services.customer_service.CustomerService.calculate_total_price" href="#services.customer_service.CustomerService.calculate_total_price">calculate_total_price</a></code></li>
<li><code><a title="services.customer_service.CustomerService.cancel_delivery" href="#services.customer_service.CustomerService.cancel_delivery">cancel_delivery</a></code></li>
<li><code><a title="services.customer_service.CustomerService.charge_payment_method" href="#services.customer_service.CustomerService.charge_payment_method">charge_payment_method</a></code></li>
<li><code><a title="services.customer_service.CustomerService.create_cart_item" href="#services.customer_service.CustomerService.create_cart_item">create_cart_item</a></code></li>
<li><code><a title="services.customer_service.CustomerService.create_customer" href="#services.customer_service.CustomerService.create_customer">create_customer</a></code></li>
<li><code><a title="services.customer_service.CustomerService.create_customer_showing" href="#services.customer_service.CustomerService.create_customer_showing">create_customer_showing</a></code></li>
<li><code><a title="services.customer_service.CustomerService.create_delivery" href="#services.customer_service.CustomerService.create_delivery">create_delivery</a></code></li>
<li><code><a title="services.customer_service.CustomerService.create_delivery_item" href="#services.customer_service.CustomerService.create_delivery_item">create_delivery_item</a></code></li>
<li><code><a title="services.customer_service.CustomerService.delete_cart_item" href="#services.customer_service.CustomerService.delete_cart_item">delete_cart_item</a></code></li>
<li><code><a title="services.customer_service.CustomerService.delete_customer" href="#services.customer_service.CustomerService.delete_customer">delete_customer</a></code></li>
<li><code><a title="services.customer_service.CustomerService.delete_payment_method" href="#services.customer_service.CustomerService.delete_payment_method">delete_payment_method</a></code></li>
<li><code><a title="services.customer_service.CustomerService.get_all_deliveries" href="#services.customer_service.CustomerService.get_all_deliveries">get_all_deliveries</a></code></li>
<li><code><a title="services.customer_service.CustomerService.get_all_showings" href="#services.customer_service.CustomerService.get_all_showings">get_all_showings</a></code></li>
<li><code><a title="services.customer_service.CustomerService.get_cart_items" href="#services.customer_service.CustomerService.get_cart_items">get_cart_items</a></code></li>
<li><code><a title="services.customer_service.CustomerService.get_customer" href="#services.customer_service.CustomerService.get_customer">get_customer</a></code></li>
<li><code><a title="services.customer_service.CustomerService.get_customer_payment_methods" href="#services.customer_service.CustomerService.get_customer_payment_methods">get_customer_payment_methods</a></code></li>
<li><code><a title="services.customer_service.CustomerService.get_customer_showing_id" href="#services.customer_service.CustomerService.get_customer_showing_id">get_customer_showing_id</a></code></li>
<li><code><a title="services.customer_service.CustomerService.get_delivery_details" href="#services.customer_service.CustomerService.get_delivery_details">get_delivery_details</a></code></li>
<li><code><a title="services.customer_service.CustomerService.rate_delivery" href="#services.customer_service.CustomerService.rate_delivery">rate_delivery</a></code></li>
<li><code><a title="services.customer_service.CustomerService.show_all_products" href="#services.customer_service.CustomerService.show_all_products">show_all_products</a></code></li>
<li><code><a title="services.customer_service.CustomerService.update_cart_item" href="#services.customer_service.CustomerService.update_cart_item">update_cart_item</a></code></li>
<li><code><a title="services.customer_service.CustomerService.update_default_theatre" href="#services.customer_service.CustomerService.update_default_theatre">update_default_theatre</a></code></li>
<li><code><a title="services.customer_service.CustomerService.validate_customer" href="#services.customer_service.CustomerService.validate_customer">validate_customer</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.6</a>.</p>
</footer>
</body>
</html>
